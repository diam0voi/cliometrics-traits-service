## Таблица соответствия идентификаторов (Mapping Table)

| Имя в JSON (от Геймдизайнеров) | Технический слаг (Slug) | Legacy ID (iOS v2.4) |
| :--- | :--- | :--- |
| **Joseph Stalin** | `sov_stalin` | 1046 |
| **sov_trotsky** | `sov_trotsky` | 1047 |
| **Winston Churchill** | `eng_churchill` | 1048 |
| **USA_FDR** | `usa_fdr` | 1049 |
| **Hirohito** | `jap_hirohito` | 1050 |

# Документация системы динамических параметров лидеров

## 1. Маппинг данных
Было выявлено несоответствие между Legacy ID (Integer) и требованиями ГД (String Slugs). 
Для решения внедрена таблица `LEADERS_MAPPING`.

**Выявленные проблемы в исходных данных:**
- Использование полных имен с пробелами (Joseph Stalin) вместо технических ключей.
- Отсутствие префиксов стран (Hirohito вместо jap_hirohito).
- Неконсистентный регистр (USA_FDR).

## 2. Алгоритм импорта данных
Для предотвращения деградации продакшна используется следующий алгоритм:
1. **Нормализация:** Перед записью в БД все ключи проходят процедуру `trim()` и `to_lower_case()`.
2. **Валидация:** Сверка со справочником `LEADERS_MAPPING`.

3. **Транзакционность:** Запись в БД выполняется атомарно (BEGIN/COMMIT).

## 4. Логика динамических комбо (Rule Engine)
Система поддерживает вычисление скрытых трейтов на лету. 

## 5. Алгоритм безопасной заливки данных (Traits System)
Валидация (Pre-check): Скрипт сверяет JSON от ГД с таблицей leader_mapping.csv. Если в JSON есть имя, которого нет в маппинге — стоп процесс.
Трансформация: Все слаги приводятся к нижнему регистру (lowercase), имена заменяются на технические ID.
Транзакционность: Заливка в БД происходит внутри одной SQL-транзакции (BEGIN ... COMMIT). Если на любой строке возникнет ошибка, база автоматически откатится к исходному состоянию.
Smoke Test: После заливки сервис автоматически дергает API для Сталина (ID 1046). Если данные пришли — деплой успешен.
Мониторинг: Включаем логирование ошибок на 1 час. При росте 500-х ошибок — немедленный откат (Rollback).
